"""
Mock MCP Client - для тестирования без реального MCP сервера
Эмулирует метаданные типовой конфигурации УТ11
"""

from typing import Optional, List, Dict

from src.clients.mcp import MCPClient


# ============== Mock Data ==============

MOCK_METADATA = {
    "Catalogs": [
        "Номенклатура", "Контрагенты", "Склады", "Организации",
        "Валюты", "ЕдиницыИзмерения", "Пользователи", "ВидыЦен",
        "ГруппыНоменклатуры", "ТипыЦенНоменклатуры", "СтавкиНДС",
        "ХарактеристикиНоменклатуры", "СерииНоменклатуры",
        "КлассификаторЕдиницИзмерения", "БанковскиеСчета"
    ],
    "Documents": [
        "РеализацияТоваровУслуг", "ПоступлениеТоваровУслуг",
        "ЗаказКлиента", "ЗаказПоставщику", "ПеремещениеТоваров",
        "ИнвентаризацияТоваров", "СчетНаОплатуКлиенту",
        "ПриходныйКассовыйОрдер", "РасходныйКассовыйОрдер",
        "СписаниеТоваров", "ОприходованиеТоваров"
    ],
    "AccumulationRegisters": [
        "ТоварыНаСкладах", "ТоварыОрганизаций", "Продажи",
        "ЗаказыКлиентов", "СвободныеОстатки", "РезервыТоваров",
        "ЗакупкиПоставщиков", "РасчетыСКлиентами", "РасчетыСПоставщиками"
    ],
    "InformationRegisters": [
        "ЦеныНоменклатуры", "ШтрихкодыНоменклатуры",
        "КурсыВалют", "НастройкиПользователей",
        "СоответствияНоменклатурыКонтрагентов"
    ]
}

MOCK_STRUCTURES = {
    ("Catalogs", "Номенклатура"): """## Справочник: Номенклатура
Иерархический: Да (группы и элементы)

### Реквизиты:
- Наименование (Строка, 150)
- Артикул (Строка, 25)  
- ЕдиницаИзмерения (СправочникСсылка.ЕдиницыИзмерения)
- ВидНоменклатуры (ПеречислениеСсылка.ВидыНоменклатуры)
- Родитель (СправочникСсылка.Номенклатура)
- ЭтоГруппа (Булево)
- СтавкаНДС (СправочникСсылка.СтавкиНДС)
- Вес (Число, 15, 3)
- Объем (Число, 15, 6)
- Описание (Строка, неограниченная)

### Табличные части:
- ЕдиницыИзмерения
  - ЕдиницаИзмерения (СправочникСсылка.ЕдиницыИзмерения)
  - Коэффициент (Число, 10, 3)
  - Штрихкод (Строка, 200)""",

    ("Catalogs", "Контрагенты"): """## Справочник: Контрагенты
Иерархический: Да (группы и элементы)

### Реквизиты:
- Наименование (Строка, 150)
- НаименованиеПолное (Строка, 500)
- ИНН (Строка, 12)
- КПП (Строка, 9)
- ОГРН (Строка, 15)
- ЮридическоеФизическоеЛицо (ПеречислениеСсылка.ЮридическоеФизическоеЛицо)
- Родитель (СправочникСсылка.Контрагенты)
- ЭтоГруппа (Булево)
- Комментарий (Строка, неограниченная)
- ГоловнойКонтрагент (СправочникСсылка.Контрагенты)

### Табличные части:
- КонтактнаяИнформация
  - Тип (ПеречислениеСсылка.ТипыКонтактнойИнформации)
  - Представление (Строка, 500)""",

    ("Catalogs", "Склады"): """## Справочник: Склады
Иерархический: Нет

### Реквизиты:
- Наименование (Строка, 100)
- ТипСклада (ПеречислениеСсылка.ТипыСкладов)
- Ответственный (СправочникСсылка.Пользователи)
- Подразделение (СправочникСсылка.СтруктураПредприятия)
- ИспользоватьОрдернуюСхему (Булево)
- ИспользоватьАдресноеХранение (Булево)""",

    ("Documents", "РеализацияТоваровУслуг"): """## Документ: РеализацияТоваровУслуг
Движения: ТоварыНаСкладах, Продажи, РасчетыСКлиентами

### Реквизиты шапки:
- Дата (Дата)
- Номер (Строка, 11)
- Организация (СправочникСсылка.Организации)
- Контрагент (СправочникСсылка.Контрагенты)
- Договор (СправочникСсылка.ДоговорыКонтрагентов)
- Склад (СправочникСсылка.Склады)
- Валюта (СправочникСсылка.Валюты)
- СуммаДокумента (Число, 15, 2)
- Комментарий (Строка, неограниченная)
- Ответственный (СправочникСсылка.Пользователи)

### Табличная часть: Товары
- Номенклатура (СправочникСсылка.Номенклатура)
- Характеристика (СправочникСсылка.ХарактеристикиНоменклатуры)
- Количество (Число, 15, 3)
- ЕдиницаИзмерения (СправочникСсылка.ЕдиницыИзмерения)
- Цена (Число, 15, 2)
- Сумма (Число, 15, 2)
- СтавкаНДС (СправочникСсылка.СтавкиНДС)
- СуммаНДС (Число, 15, 2)

### Табличная часть: Услуги
- Номенклатура (СправочникСсылка.Номенклатура)
- Содержание (Строка, 1000)
- Количество (Число, 15, 3)
- Цена (Число, 15, 2)
- Сумма (Число, 15, 2)""",

    ("Documents", "ПоступлениеТоваровУслуг"): """## Документ: ПоступлениеТоваровУслуг
Движения: ТоварыНаСкладах, ТоварыОрганизаций, РасчетыСПоставщиками

### Реквизиты шапки:
- Дата (Дата)
- Номер (Строка, 11)
- Организация (СправочникСсылка.Организации)
- Контрагент (СправочникСсылка.Контрагенты)
- Договор (СправочникСсылка.ДоговорыКонтрагентов)
- Склад (СправочникСсылка.Склады)
- Валюта (СправочникСсылка.Валюты)
- СуммаДокумента (Число, 15, 2)

### Табличная часть: Товары
- Номенклатура (СправочникСсылка.Номенклатура)
- Количество (Число, 15, 3)
- Цена (Число, 15, 2)
- Сумма (Число, 15, 2)
- СтавкаНДС (СправочникСсылка.СтавкиНДС)""",

    ("AccumulationRegisters", "ТоварыНаСкладах"): """## Регистр накопления: ТоварыНаСкладах
Тип регистра: Остатки

### Измерения:
- Номенклатура (СправочникСсылка.Номенклатура)
- Характеристика (СправочникСсылка.ХарактеристикиНоменклатуры)
- Склад (СправочникСсылка.Склады)
- Серия (СправочникСсылка.СерииНоменклатуры)

### Ресурсы:
- Количество (Число, 15, 3)

### Регистраторы:
- РеализацияТоваровУслуг
- ПоступлениеТоваровУслуг
- ПеремещениеТоваров
- СписаниеТоваров
- ОприходованиеТоваров
- ИнвентаризацияТоваров""",

    ("AccumulationRegisters", "Продажи"): """## Регистр накопления: Продажи
Тип регистра: Обороты

### Измерения:
- Номенклатура (СправочникСсылка.Номенклатура)
- Характеристика (СправочникСсылка.ХарактеристикиНоменклатуры)
- Контрагент (СправочникСсылка.Контрагенты)
- Организация (СправочникСсылка.Организации)
- Менеджер (СправочникСсылка.Пользователи)

### Ресурсы:
- Количество (Число, 15, 3)
- Выручка (Число, 15, 2)
- Стоимость (Число, 15, 2)

### Регистраторы:
- РеализацияТоваровУслуг""",

    ("InformationRegisters", "ЦеныНоменклатуры"): """## Регистр сведений: ЦеныНоменклатуры
Периодичность: В пределах дня
Режим записи: Независимый

### Измерения:
- Номенклатура (СправочникСсылка.Номенклатура)
- Характеристика (СправочникСсылка.ХарактеристикиНоменклатуры)
- ВидЦены (СправочникСсылка.ВидыЦен)

### Ресурсы:
- Цена (Число, 15, 2)
- Валюта (СправочникСсылка.Валюты)
- ЕдиницаИзмерения (СправочникСсылка.ЕдиницыИзмерения)""",

    ("InformationRegisters", "КурсыВалют"): """## Регистр сведений: КурсыВалют
Периодичность: В пределах дня
Режим записи: Независимый

### Измерения:
- Валюта (СправочникСсылка.Валюты)

### Ресурсы:
- Курс (Число, 15, 4)
- Кратность (Число, 10, 0)"""
}


class MockMCPClient(MCPClient):
    """
    Mock MCP клиент для тестирования без реального сервера
    """
    
    async def connect(self) -> bool:
        """Mock: всегда успешно"""
        self._initialized = True
        print("[MockMCP] Connected (emulation mode)")
        return True
    
    async def disconnect(self):
        """Mock: отключение"""
        self._initialized = False
        print("[MockMCP] Disconnected")
    
    async def list_metadata_objects(
        self, 
        meta_type: str, 
        name_mask: str = "*",
        max_items: int = 100
    ) -> Optional[str]:
        """Возвращает mock-список объектов"""
        objects = MOCK_METADATA.get(meta_type, [])
        
        # Применяем маску
        if name_mask != "*":
            mask_lower = name_mask.lower().replace("*", "")
            objects = [o for o in objects if mask_lower in o.lower()]
        
        # Ограничиваем количество
        objects = objects[:max_items]
        
        if not objects:
            return f"(No objects found for {meta_type})"
        
        return "\n".join(f"- {obj}" for obj in objects)
    
    async def get_metadata_structure(
        self,
        meta_type: str,
        name: str
    ) -> Optional[str]:
        """Возвращает mock-структуру объекта"""
        key = (meta_type, name)
        
        if key in MOCK_STRUCTURES:
            return MOCK_STRUCTURES[key]
        
        # Заглушка для неизвестных
        return f"""## {meta_type}: {name}
(Structure not found in mock data)

### Предполагаемые реквизиты:
- Наименование (Строка)
- Код (Строка)"""
    
    async def list_tools(self) -> Optional[List[Dict]]:
        """Возвращает список tools"""
        return [
            {
                "name": "list_metadata_objects", 
                "description": "Получить список объектов метаданных"
            },
            {
                "name": "get_metadata_structure", 
                "description": "Получить структуру объекта метаданных"
            }
        ]
